# Основы межсетевого экранирования

## Цель занятия

По итогам занятия студенты смогут:
- Объяснять принципы работы межсетевых экранов на уровнях сетевой модели OSI (3-4 уровни), их роль в сетевой безопасности и интеграцию с другими технологиями защиты.
- Классифицировать типы межсетевых экранов по методам анализа трафика, понимать их технические ограничения и сценарии применения.
- Описывать различные политики firewall с техническими деталями их реализации и применения в реальных сетевых сценариях.
- Применять знания о топологии сетей, DMZ и архитектуре с несколькими уровнями защиты для проектирования защищенных инфраструктур.
- Планировать внедрение firewall, включая анализ рисков, выбор оборудования/ПО и процедуры тестирования и мониторинга.

## Введение

Межсетевые экраны (firewall) являются фундаментом сетевой безопасности, функционируя на 3-м (сетевом) и 4-м (транспортном) уровнях модели OSI. Они анализируют заголовки пакетов IP, TCP/UDP для принятия решений о пропуске или блокировке трафика. В эпоху цифровых технологий, когда атаки на сети происходят ежедневно (по данным Verizon DBIR 2023, 74% инцидентов включают firewall-обход), умение настраивать и управлять firewall критически важно для системного администратора. Эта тема занимает центральное место в профессиональной деятельности, особенно в модуле ПМ.03 «Эксплуатация операционных систем», где администраторы Linux (с iptables/firewalld) и Windows (с Windows Firewall) систем регулярно сталкиваются с задачами защиты серверов и рабочих станций от несанкционированного доступа.

Актуальность темы обусловлена ростом киберугроз: от DDoS-атак (которые firewall может минимизировать путем ограничения скорости) до вредоносного ПО (блокировка C2-каналов). Firewall помогает предотвратить утечки данных, блокировать подозрительный трафик и обеспечивать стабильную работу сети через механизмы like rate limiting и deep packet inspection. Без должной настройки firewall администратор рискует подвергнуть систему рискам, что может привести к потере данных или нарушению конфиденциальности. Технически, firewall работает путем сравнения входящих пакетов с правилами в таблице (например, chains в iptables), применяя действия ACCEPT, DROP, REJECT.

## Основные понятия и определения

- **Межсетевой экран (firewall)**: Устройство или программное обеспечение, контролирующее входящий и исходящий сетевой трафик на основе заданных правил. Принцип работы: каждый пакет проходит через фильтр, где проверяются критерии (IP, порт, протокол, флаги). Аналогия: firewall как охрана на входе в здание — проверяет каждого посетителя по списку разрешений. Технически, реализуется через ядро ОС (netfilter в Linux) или драйверы (Windows Filtering Platform).

- **Правило firewall**: Инструкция, определяющая, разрешить или заблокировать трафик. Структура правила: условие (match) + действие (target). Пример: "Разрешить входящие соединения на порт 80 (HTTP)" — iptables: -A INPUT -p tcp --dport 80 -j ACCEPT. Правила обрабатываются последовательно до первого совпадения.

- **Политика firewall**: Набор правил, определяющих общую стратегию фильтрации. Политика может быть "по умолчанию запретить все, кроме разрешенного" (whitelist: default DROP) или наоборот (blacklist: default ACCEPT). Технически, политика — это default chain policy в iptables, влияющая на производительность (whitelist требует больше правил).

- **Пакетный фильтр**: Простейший тип firewall, анализирующий заголовки пакетов (IP-адреса, порты, протоколы). Принцип: без учета состояния соединения. Техническое описание: работает на уровне 3-4 OSI, проверяет поля IPv4/TCP (source/dest IP, source/dest port, flags как SYN). Недостаток: уязвим к spoofing (подмена IP).

- **Состояние TCP-соединения**: Фазы соединения — SYN (начало handshake), SYN-ACK (подтверждение), ACK (завершение). Firewall с отслеживанием состояний (stateful) помнит активные соединения в таблице состояний (connection tracking table). Принцип: разрешает ответный трафик только для установленных соединений, предотвращая unsolicited packets.

- **NAT (Network Address Translation)**: Преобразование IP-адресов для сокрытия внутренней сети. Типы: SNAT (source NAT для исходящего), DNAT (destination NAT для входящего). Пример: один внешний IP для нескольких внутренних устройств через PAT. Технически, изменяет заголовки IP в prerouting/postrouting chains iptables.

- **DMZ (Demilitarized Zone)**: Изолированная сеть между внутренней и внешней сетью, где размещаются публичные серверы (веб, почта). Принцип: двойная фильтрация — от интернета и от внутренней сети. Технически, отдельная VLAN или subnet с правилами, блокирующими трафик между DMZ и внутренней сетью.

- **Интранет**: Внутренняя корпоративная сеть, защищенная firewall. Технически, private IP-диапазоны (RFC 1918: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16), доступ ограничен через firewall-правила.

- **Экстранет**: Расширение интранета для партнеров, с ограниченным доступом. Принцип: аутентификация (VPN или сертификаты) для доступа к определенным ресурсам, firewall блокирует несанкционированный трафик.

## Теоретическая часть

### Основы сетевой безопасности и технологии межсетевых экранов

Сетевая безопасность начинается с понимания угроз: несанкционированный доступ (exploitation уязвимостей), атаки на уязвимости (zero-day), вредоносный код (malware propagation). Firewall — первая линия обороны, фильтруя трафик между сетями. Технологии firewall эволюционировали от простых пакетных фильтров к сложным системам с инспекцией содержимого (deep packet inspection — DPI, анализирует payload пакетов на сигнатуры угроз). Они интегрируются с другими средствами защиты, такими как антивирусы (endpoint protection) и системы обнаружения вторжений (IDS/IPS — intrusion detection/prevention systems). В работе администратора firewall обеспечивает сегментацию сети (network segmentation), предотвращая распространение угроз через lateral movement. Технически, firewall использует таблицы правил (rulebase), где каждый пакет сравнивается с критериями, и если совпадение — применяется действие (ACCEPT/DROP/LOG).

### Классификация межсетевых экранов

Firewall классифицируют по уровню анализа трафика и методам:
- **Пакетные фильтры (stateless)**: Проверяют только заголовки пакетов. Принцип работы: каждый пакет независимо, без контекста соединения. Быстрые (низкая латентность), но уязвимы к spoofing (атакующий подменяет IP для обхода). Техническое ограничение: не видит состояния TCP, поэтому пропускает unsolicited SYN-пакеты.
- **С отслеживанием состояний (stateful)**: Помнят соединения, анализируют TCP-состояния. Принцип: ведет таблицу состояний (state table), разрешая трафик только для valid соединений. Более надежные, предотвращают SYN flood. Технически, использует connection tracking (в netfilter — conntrack module).
- **Прокси-firewall (application-level gateways)**: Действуют как посредники, проверяя весь трафик. Принцип: устанавливает соединение от клиента к прокси, затем от прокси к серверу, анализируя application-layer данные. Медленные (высокая латентность из-за двойного соединения), но безопасные (скрывает внутренние адреса, фильтрует по контенту).
- **Новые поколения (NGFW)**: Интегрируют deep packet inspection (DPI — анализирует payload на threats), защиту от угроз (malware detection), user identity (integration с Active Directory). Принцип: комбинирует stateful filtering с advanced analytics.

Эта классификация помогает выбрать firewall под конкретные нужды: для домашней сети — простой stateless, для предприятия — stateful или NGFW с hardware acceleration.

### Ограниченность анализа межсетевого экрана

Firewall не всесилен: он не защищает от внутренних угроз (insider attacks), не анализирует зашифрованный трафик (если не настроена инспекция SSL — SSL/TLS decryption), и может быть обойден через уязвимости в ОС (kernel exploits) или туннелирование (encapsulation в allowed протоколах). Ограничения включают производительность (большие rulebases замедляют сеть — throughput drop), сложность настройки (human error в правилах), и false positives (блокировка легитимного трафика). Администратор должен комбинировать firewall с другими инструментами, такими как VPN (для шифрования), HIDS (host-based IDS) и regular updates.

### Политика межсетевого экрана и её типы

Политика — основа конфигурации. Она определяет, как firewall обрабатывает трафик, влияя на security posture. Переход от простых правил к политикам делает firewall более управляемым через abstraction (policy-based management).

- **Политики на основе IP-адресов и протоколов**: Фильтрация по источнику/назначению IP, портам, протоколам (TCP, UDP, ICMP). Принцип: проверка полей в IP/TCP заголовках. Пример: "Блокировать трафик с IP 192.168.1.100 на порт 22" — предотвращает SSH от known bad IPs. Технически, использует CIDR notation для subnets, flags для TCP (SYN, ACK).

- **Политики на основе идентификации пользователя**: Связывают правила с пользователями (через аутентификацию). Принцип: integration с AAA (authentication, authorization, accounting) servers, как RADIUS/LDAP. Полезно в корпоративных сетях для персонализированного доступа (user-based rules). Технически, captive portal или 802.1X для аутентификации перед фильтрацией.

- **Политики на основе сетевой активности**: Мониторят поведение трафика, блокируя аномалии (например, DDoS — excessive packets per second). Stateful firewall использует это для отслеживания состояний, rate limiting. Принцип: anomaly detection через thresholds (e.g., >100 SYN/sec).

Эти политики органично дополняют друг друга: от базовой фильтрации по IP к продвинутой на основе поведения, обеспечивая defense in depth.

### Состояния TCP-соединения

TCP-соединения имеют состояния: CLOSED (нет соединения), LISTEN (сервер ждет), SYN_SENT (клиент отправил SYN), SYN_RECEIVED (сервер ответил SYN-ACK), ESTABLISHED (handshake завершен), FIN_WAIT (закрытие), CLOSE_WAIT. Firewall с отслеживанием состояний (stateful) разрешает только легитимные переходы, предотвращая атаки типа SYN flood (flood SYN без ACK). Это важно для протоколов вроде HTTP, где соединения устанавливаются последовательно. Технически, conntrack module в Linux ведет state table, обновляя состояния по флагам TCP (e.g., SYN устанавливает NEW, ACK — ESTABLISHED).

### Межсетевые экраны с возможностями NAT

NAT маскирует внутренние IP, экономя адреса (IPv4 exhaustion) и скрывая топологию (obfuscation). Firewall с NAT комбинирует фильтрацию и трансляцию. Пример: PAT (Port Address Translation) для нескольких устройств за одним IP (maps internal IP:port to external IP:unique_port). В администрировании это упрощает управление трафиком, но усложняет logging (требует NAT logging). Технически, NAT table в iptables: PREROUTING для DNAT, POSTROUTING для SNAT.

### Топология сети при использовании межсетевых экранов

Топология зависит от firewall: простая — firewall между внутренней и внешней сетью (bastion host); сложная — с несколькими firewall для зон (zoned security). Принципы построения окружения: сегментация (subnets/VLANs), минимальные привилегии (least privilege — allow only needed), многоуровневая защита (defense in depth). Технически, firewall как choke point, где весь трафик проходит через inspection.

### Архитектура с несколькими уровнями межсетевых экранов

Многоуровневая архитектура включает внешний firewall (edge), внутренний (internal) и промежуточные (segmentation firewalls). Пример: первый уровень блокирует базовые угрозы (stateless), второй анализирует глубоко (NGFW). Это повышает безопасность через layered defense, но требует координации правил (consistent policies) и управления (centralized management console). Технически, экраны в series или parallel, с logging aggregation.

### DMZ-сети

DMZ — буферная зона для публичных сервисов. Принцип: двойная фильтрация — firewall отделяет DMZ от интернета (allow inbound to ports 80/443), и от внутренней сети (deny all inbound from DMZ). Серверы в DMZ (веб, FTP) доступны извне, но изолированы от критических ресурсов. Технически, separate subnet (e.g., 192.168.2.0/24), rules like: FROM internet TO DMZ:80 ACCEPT, FROM DMZ TO internal: DROP.

### Интранет и Экстранет

Интранет — защищенная внутренняя сеть, доступная сотрудникам. Принцип: firewall ограничивает доступ из интернета (block all inbound except VPN). Технически, private addressing, access via authenticated tunnels.

Экстранет расширяет интранет для партнеров, с ограниченным доступом. Принцип: аутентификация (certificates or VPN), firewall rules для selective access (e.g., allow to specific shares).

### Расположение серверов в DMZ-сетях

Серверы размещают в DMZ для баланса: доступность извне и защита. Правила firewall разрешают трафик на нужные порты (e.g., 80 for HTTP), блокируя остальное. Пример: веб-сервер на порт 80, но без доступа к базе данных внутренней сети (separate firewall rules). Технически, hardening servers (minimal services), monitoring for breaches.

### Планирование и внедрение межсетевого экрана

Планирование включает анализ сети (threat modeling, asset inventory), выбор firewall (hardware vs software, vendor like Cisco/Palo Alto), определение политик (policy development). Внедрение: настройка правил (rulebase creation), тестирование (penetration testing, rule verification), мониторинг (logging, SIEM integration). Администратор документирует изменения, обучает персонал. Регулярные обновления правил адаптируют к новым угрозам (threat intelligence feeds).

## Практическая значимость

В работе администратора firewall применяется для защиты серверов: в Linux — iptables (chains: INPUT/OUTPUT/FORWARD) или firewalld (zones) для фильтрации трафика; в Windows — Windows Firewall (WFP API) для блокировки портов. Знания о политиках и топологии помогают проектировать безопасные сети, предотвращая инциденты. Практика включает настройку правил для приложений, мониторинг логов (syslog) и реагирование на атаки (incident response).

## Примеры команд, конфигураций или скриншотов

### Linux (iptables)

Базовая настройка: разрешить SSH, блокировать остальное.

```
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -j DROP
```

Состояние TCP: включить модуль state.

```
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

NAT: маскарадинг.

```
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

### Windows (netsh)

Включить firewall.

```
netsh advfirewall set allprofiles state on
```

Добавить правило: блокировать порт 3389 (RDP).

```
netsh advfirewall firewall add rule name="Block RDP" dir=in action=block protocol=TCP localport=3389
```

Пример конфигурации DMZ: правила для веб-сервера в DMZ, блокирующие доступ к внутренней сети.

```
netsh advfirewall firewall add rule name="DMZ Web" dir=in action=allow protocol=TCP localport=80 remoteip=DMZ_subnet
netsh advfirewall firewall add rule name="Block DMZ to Internal" dir=out action=block remoteip=internal_subnet
```

## Вопросы для самопроверки

1. Объясните принцип работы firewall на уровнях OSI и приведите пример правила iptables.
2. Сравните stateless и stateful firewall, указав технические преимущества и ограничения.
3. Как политики на основе сетевой активности предотвращают DDoS-атаки?
4. Опишите процесс NAT в firewall и его роль в маскировке внутренней сети.
5. Как архитектура с DMZ обеспечивает защиту серверов и почему блокируется трафик из DMZ во внутреннюю сеть?

## Рекомендуемые источники

- Официальная документация Linux: iptables — https://netfilter.org/documentation/
- Руководство по Windows Firewall: https://docs.microsoft.com/ru-ru/windows/security/threat-protection/windows-firewall/
- Книга "Сетевая безопасность" (авторы: различные) — доступна в учебных библиотеках.
- Онлайн-курс по сетевой безопасности на Coursera (на русском языке).
